# ğŸ“¦ BÆ°á»›c 1: Upload file CSV tá»« mÃ¡y
from google.colab import files
import pandas as pd
import numpy as np

uploaded = files.upload()  # Má»Ÿ há»™p thoáº¡i chá»n file CSV (vÃ­ dá»¥: processed_data.csv)

# Láº¥y tÃªn file CSV vá»«a upload
file_path = list(uploaded.keys())[0]

# ğŸ“¥ BÆ°á»›c 2: Äá»c file CSV
df = pd.read_csv(file_path)
print(f"âœ… ÄÃ£ náº¡p dá»¯ liá»‡u tá»« file: {file_path}")
print(df.head())
# âš™ï¸ BÆ°á»›c 3: Xá»­ lÃ½ dá»¯ liá»‡u â€“ tÃ­nh rolling mean vÃ  z-score cho má»™t sá»‘ sensor
target_sensors = ['sensor_2', 'sensor_3', 'sensor_7']
window_size = 10

# TÃ­nh rolling mean theo tá»«ng engine (unit_number)
for sensor in target_sensors:
    df[f'{sensor}_roll_mean'] = df.groupby('unit_number')[sensor].transform(
        lambda x: x.rolling(window=window_size, min_periods=1).mean()
    )
    df[f'{sensor}_z'] = (df[sensor] - df[sensor].mean()) / df[sensor].std()
# âš™ï¸ BÆ°á»›c 3: Xá»­ lÃ½ dá»¯ liá»‡u â€“ tÃ­nh rolling mean vÃ  z-score cho má»™t sá»‘ sensor
target_sensors = ['sensor_2', 'sensor_3', 'sensor_7']
window_size = 10

# TÃ­nh rolling mean theo tá»«ng engine (unit_number)
for sensor in target_sensors:
    df[f'{sensor}_roll_mean'] = df.groupby('unit_number')[sensor].transform(
        lambda x: x.rolling(window=window_size, min_periods=1).mean()
    )
    df[f'{sensor}_z'] = (df[sensor] - df[sensor].mean()) / df[sensor].std()
# ğŸš¨ BÆ°á»›c 4: Flag anomaly náº¿u z-score vÆ°á»£t ngÆ°á»¡ng
anomaly_conditions = (df['sensor_2_z'].abs() > 2.5) | \
                     (df['sensor_3_z'].abs() > 2.5) | \
                     (df['sensor_7_z'].abs() > 2.5)

df['anomaly_flag'] = np.where(anomaly_conditions, 1, 0)

# In ra sá»‘ dÃ²ng báº¥t thÆ°á»ng
print(f"âš ï¸ Sá»‘ dÃ²ng bá»‹ flag báº¥t thÆ°á»ng: {df['anomaly_flag'].sum()}")
# ğŸ’¾ BÆ°á»›c 5: Xuáº¥t káº¿t quáº£ ra file CSV má»›i
output_path = 'failure_flags.csv'
df.to_csv(output_path, index=False)
print(f"âœ… ÄÃ£ lÆ°u file: {output_path}")

# ğŸ“¤ BÆ°á»›c 6: Táº£i file vá» mÃ¡y
files.download(output_path)
